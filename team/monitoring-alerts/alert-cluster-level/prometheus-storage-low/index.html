<!doctype html><html dir=ltr lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>Prometheus Storage Alerts | Aurora
</title><link rel=icon href=/favicon.ico type=image/x-icon><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css as=style crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.10.0/dist/gcds-utility.min.css><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.42.0/dist/gcds/gcds.css><script async type=module src=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.42.0/dist/gcds/gcds.esm.js></script><link rel=stylesheet href=/scss/main.css><link rel=stylesheet href=/scss/custom.css><style>html{font-size:16px}body{font-size:var(--gcds-font-sizes-text);line-height:var(--gcds-line-heights-text);color:var(--gcds-color-grayscale-1000);font-family:var(--gcds-font-families-body),sans-serif;margin:0;animation:fade .05s forwards ease-in-out}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css></head><body style=margin:0 class=character-limit><main><gcds-container centered size=md><gcds-text size=caption style="text-align: center;"><strong>Alpha</strong>&nbsp;&nbsp;This is an experimental service.</gcds-text>
</gcds-container><gcds-header lang=en lang-href signature-variant=colour skip-to-href=#><gcds-search lang=en slot=search action=/sr/srb.html placeholder=Aurora></gcds-search><gcds-top-nav slot=menu label="Top navigation" alignment=right><gcds-nav-link href=/ slot=home>GC Cloud One: Aurora
</gcds-nav-link><gcds-nav-group open-trigger=Platform menu-label=Platform><gcds-nav-link href=/proposal>Proposal
</gcds-nav-link><gcds-nav-link href=/roadmap>Roadmap
</gcds-nav-link><gcds-nav-link href=/vision>Vision
</gcds-nav-link><gcds-nav-link href=/architecture>Architecture
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="User Guides" menu-label="User Guides"><gcds-nav-link href=/user-guides/onboarding>Onboarding
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Team menu-label=Team><gcds-nav-link href=/team/sop>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/>Monitoring
</gcds-nav-link><gcds-nav-link href=/team/appendix>Appendix
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Community menu-label=Community><gcds-nav-link href=/get-involved>Get involved
</gcds-nav-link><gcds-nav-link href=/rules-of-engagement>Rules of Engagement
</gcds-nav-link><gcds-nav-link href=/technical-advisory-group>Technical Advisory Group
</gcds-nav-link></gcds-nav-group></gcds-top-nav><gcds-breadcrumbs slot=breadcrumb><gcds-breadcrumbs-item href="https://hosting-services-hebergement.canada.ca/s/gc-cloud-one?language=en_US">GC Cloud One</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/>Aurora</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/>Team Guide</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/monitoring-alerts/>Monitoring and Alerting</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/monitoring-alerts/alert-cluster-level/>Cluster Level Alerts</gcds-breadcrumbs-item>
</gcds-breadcrumbs></gcds-header><gcds-container size=xl main-container centered tag=main><gcds-grid tag=section columns=1fr columns-desktop="
        1fr 3fr
      " align-items=start class=hydrated><aside role=complementary><gcds-side-nav label="Team Guide"><gcds-nav-link href=/team/>Team Guide
</gcds-nav-link><gcds-nav-group open-trigger="Standard Operating Procedures" menu-label="Standard Operating Procedures"><gcds-nav-link href=/team/standard-operating-procedures/>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/issue-tracking/>Issue Tracking
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/adding-components-aurora-platform-chart/>Adding components to Aurora Platform Charts
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/backup-disaster-recovery/>Backup and Disaster Recovery
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/bootstrap-cluster/>Bootstrap Cluster
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/infrastructure-and-configuration-management/>Infrastructure and Configuration Management
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/issue-naming/>Issue and PR Naming Conventions
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/enterprise-landing-zone/>Onboarding process for the Enterprise Landing Zone
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="Monitoring and Alerting" menu-label="Monitoring and Alerting" open><gcds-nav-link href=/team/monitoring-alerts/>Monitoring and Alerting
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/prometheus/>Prometheus
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/prometheus-operator/>Prometheus Operator
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alertmanager/>Alertmanager
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/blackbox-exporter/>Blackbox Exporter
</gcds-nav-link><gcds-nav-group open-trigger="Cluster Level Alerts" menu-label="Cluster Level Alerts" open><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/>Cluster Level Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/cert-manager/>Cert Manager Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/dns/>DNS Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/node/>Node Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/node-pool-pod-capacity/>Node Pool Capacity Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/probe-failure/>Probe Failure Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/prometheus-storage-low/ current=true>Prometheus Storage Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/ssl-cert-expiring-soon/>SSL Certificate Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/velero/>Velero Alerts
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="Namespace Level Alerts" menu-label="Namespace Level Alerts"><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/>Namespace Level Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/container/>Container Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/job/>Job Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/persistent-volume-claims/>Persistent Volume Claim Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/pod-not-ready/>Pod Alerts
</gcds-nav-link></gcds-nav-group></gcds-nav-group><gcds-nav-group open-trigger=Appendix menu-label=Appendix><gcds-nav-link href=/team/appendix/>Appendix
</gcds-nav-link><gcds-nav-link href=/team/appendix/acronyms/>Acronyms
</gcds-nav-link><gcds-nav-link href=/team/appendix/lexicon/>Lexicon</gcds-nav-link></gcds-nav-group></gcds-side-nav></aside><section class=mb-400><gcds-heading tag=h1>Prometheus Storage Alerts</gcds-heading>
<gcds-alert alert-role=danger container=full heading="Avis de traduction" hide-close-btn=true hide-role-icon=false is-fixed=false class="hydrated mb-400"><gcds-text>Veuillez noter que ce document est actuellement en cours de développement actif et pourrait être sujet à des révisions. Une fois terminé, il sera entièrement traduit en français et mis à disposition dans sa version finale.</gcds-text>
</gcds-alert><gcds-heading tag=h2 id=alert-prometheusstoragelow character-limit=true>Alert: PrometheusStorageLow<gcds-link href=#alert-prometheusstoragelow class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>PrometheusStorageLow alerts are configured to occur at the cluster level. It triggers when Prometheus disk usage is over 85% in the specified environment. This alert indicates that the storage needs to be increased for that environment.</gcds-text>
<gcds-heading tag=h2 id=alert-prometheusdiskmayfillin60hours character-limit=true>Alert: PrometheusDiskMayFillIn60Hours<gcds-link href=#alert-prometheusdiskmayfillin60hours class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>PrometheusDiskMayFillIn60Hours alerts are configured to occur at the cluster level. It triggers when Prometheus disk usage is predicted to go over 90% within 60 hours. This alert indicates that either the storage needs to be increased for that environment or that something is consuming storage capacity at an abnormal rate.</gcds-text>
<gcds-heading tag=h2 id=resolution-process character-limit=true>Resolution Process<gcds-link href=#resolution-process class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>The resolution process is shared for both alerts. Please note PrometheusDiskMayFill is &ldquo;rate based&rdquo;, please check the Grafana dashboard for the Prometheus disk. If it is a gradual increase (with a bit of see-saw for compression), which is typically the case, proceed to the rest of the resolution process – the disk simply requires more storage. In the event there is a sudden &ldquo;cliff&rdquo; then it is worth checking if there have been any recent changes (new recording rules, new metrics, new data sources) that may be writing an abnormal amount of data to Prometheus&rsquo; disk.</gcds-text>
<gcds-heading tag=h3 id=storage-analysis character-limit=true>Storage analysis<gcds-link href=#storage-analysis class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>The resolution will be the same on each environment: increase the Prometheus&rsquo;s storage capacity. Due to different volumes of workloads in each environment, the required changes will vary. For example:</gcds-text><ul><li>example 1: an alert for the production cluster has been received; it was previously discussed that the retention period of the prometheus logs should be increased to 30d from 10d. In this case, the storage was quadrupled to account for tripling the retention period. This accounted for the 3x longer retention period and a 1/3 extra overheard.</li><li>example 2: an alert for the development cluster was received; as development is constantly expanding with new projects and storage is not overly expensive, it was decided to double the storage size</li></ul><gcds-heading tag=h3 id=resolution-steps character-limit=true>Resolution steps<gcds-link href=#resolution-steps class=pilcrow>¶</gcds-link></gcds-heading><ol><li>Increase the storage size to the
<gcds-link href=https://azure.microsoft.com/en-us/pricing/details/managed-disks>next available storage pricing tier</gcds-link>, typically by doubling the storage.</li><li>In the environment platform repo, increase the Helm value
<gcds-link href=https://github.com/prometheus-community/helm-charts/blob/056b60ce14937355da8f5bd8e8c7bd3bd042b9d1/charts/kube-prometheus-stack/values.yaml#L2476><code>prometheusSpec.storageSpec.storage</code> (check for current kube-prometheus-stack version)</gcds-link> in the appropriate kube-prometheus-stack Helm values file and create an MR. Confirm there are no issues in the plan.<ul><li>ex: <code>module_helm_kube_prometheus_stack</code></li></ul></li><li>Before merging, perform the following operations manually on the Kubernetes cluster:<ol><li>Scale down the Prometheus Operator to 0 replicas. This prevents the Prometheus Operator from scaling Prometheus back up too quickly in the following step.</li><li>Scale down Prometheus to 0 replicas. This allows existing Prometheus pod(s) to release their PVC(s), so that the PVC(s) can be expanded.</li><li>Edit the Prometheus PVC to set <code>spec.resources.requests.storage</code> to the new value. This is due to a present Kubernetes limitation where PVCs associated to a StatefulSet do not automatically expand as the corresponding StatefulSet requests more storage.</li></ol></li><li>Merge and apply the Terraform plan. This will scale everything back up, but you may need to re-plan/re-apply once: as the Operator is coming back, there may be timeout errors for other resources that depend on it (e.g. webhooks, rule changes).</li><li>Wait for the Prometheus UI to come up. It might have a few minutes of no healthy upstream.<ul><li>You can confirm the new size by querying <code>kubelet_volume_stats_capacity_bytes{namespace="monitoring"} / 1000000000</code></li></ul></li></ol><gcds-heading tag=h3 id=troubleshooting character-limit=true>Troubleshooting<gcds-link href=#troubleshooting class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>If you get the error &ldquo;<code>forbidden: only dynamically provisioned pvc can be resized and the storageclass that provisions the pvc must support resize</code>&rdquo;, first edit the storageclass default to add <code>allowVolumeExpansion: true</code> at the leftmost indentation.</gcds-text>
<gcds-date-modified lang=en>0001-01-01</gcds-date-modified></section></gcds-grid></gcds-container></main><gcds-footer lang=en display=compact contextual-heading=Aurora contextual-links='{ "Contact us": "/contact","Report an issue": "https://github.com/gccloudone/aurora/issues/new/choose","About us": "/about" }'></gcds-footer><script src=https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js></script><script>const style=document.createElement("style");style.innerHTML=`
    .glightbox-container.glightbox-custom-white-bg img {
      background: white !important;
    }
  `,document.head.appendChild(style);const lightbox=GLightbox({openEffect:"zoom",closeEffect:"fade",skin:"custom-white-bg"})</script></body></html>