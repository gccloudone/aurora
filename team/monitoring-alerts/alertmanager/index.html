<!doctype html><html dir=ltr lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>Alertmanager | Aurora
</title><link rel=icon href=/favicon.ico type=image/x-icon><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css as=style crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.10.0/dist/gcds-utility.min.css><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.42.0/dist/gcds/gcds.css><script async type=module src=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.42.0/dist/gcds/gcds.esm.js></script><link rel=stylesheet href=/scss/main.css><link rel=stylesheet href=/scss/custom.css><style>html{font-size:16px}body{font-size:var(--gcds-font-sizes-text);line-height:var(--gcds-line-heights-text);color:var(--gcds-color-grayscale-1000);font-family:var(--gcds-font-families-body),sans-serif;margin:0;animation:fade .05s forwards ease-in-out}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css></head><body style=margin:0 class=character-limit><main><gcds-container centered size=md><gcds-text size=caption style="text-align: center;"><strong>Alpha</strong>&nbsp;&nbsp;This is an experimental service.</gcds-text>
</gcds-container><gcds-header lang=en lang-href signature-variant=colour skip-to-href=#><gcds-search lang=en slot=search action=/sr/srb.html placeholder=Aurora></gcds-search><gcds-top-nav slot=menu label="Top navigation" alignment=right><gcds-nav-link href=/ slot=home>GC Cloud One: Aurora
</gcds-nav-link><gcds-nav-group open-trigger=Platform menu-label=Platform><gcds-nav-link href=/proposal>Proposal
</gcds-nav-link><gcds-nav-link href=/vision>Vision
</gcds-nav-link><gcds-nav-link href=/architecture>Architecture
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Team menu-label=Team><gcds-nav-link href=/team/sop>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/>Monitoring
</gcds-nav-link><gcds-nav-link href=/team/appendix>Appendix
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Community menu-label=Community><gcds-nav-link href=/get-involved>Get involved
</gcds-nav-link><gcds-nav-link href=/rules-of-engagement>Rules of Engagement
</gcds-nav-link><gcds-nav-link href=/technical-advisory-group>Technical Advisory Group
</gcds-nav-link></gcds-nav-group><gcds-nav-link href=/contact slot>Contact us
</gcds-nav-link></gcds-top-nav><gcds-breadcrumbs slot=breadcrumb><gcds-breadcrumbs-item href="https://hosting-services-hebergement.canada.ca/s/gc-cloud-one?language=en_US">GC Cloud One</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/>Aurora</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/>Team Guide</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/monitoring-alerts/>Monitoring and Alerting</gcds-breadcrumbs-item>
</gcds-breadcrumbs></gcds-header><gcds-container size=xl main-container centered tag=main><gcds-grid tag=section columns=1fr columns-desktop="
        1fr 3fr
      " align-items=start class=hydrated><aside role=complementary><gcds-side-nav label="Team Guide"><gcds-nav-link href=/team/>Team Guide
</gcds-nav-link><gcds-nav-group open-trigger="Standard Operating Procedures" menu-label="Standard Operating Procedures"><gcds-nav-link href=/team/standard-operating-procedures/>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/backup-disaster-recovery/>Backup and Disaster Recovery
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/bootstrap-cluster/>Bootstrap Cluster
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/infrastructure-and-configuration-management/>Infrastructure and Configuration Management
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/issue-naming/>Issue and PR Naming Conventions
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/enterprise-landing-zone/>Onboarding process for the Enterprise Landing Zone
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="Monitoring and Alerting" menu-label="Monitoring and Alerting" open><gcds-nav-link href=/team/monitoring-alerts/>Monitoring and Alerting
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/prometheus/>Prometheus
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/prometheus-operator/>Prometheus Operator
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alertmanager/ current=true>Alertmanager
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/blackbox-exporter/>Blackbox Exporter
</gcds-nav-link><gcds-nav-group open-trigger="Cluster Level Alerts" menu-label="Cluster Level Alerts"><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/>Cluster Level Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/cert-manager/>Cert Manager Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/node/>Node Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/node-pool-pod-capacity/>Node Pool Capacity Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/probe-failure/>Probe Failure Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/prometheus-storage-low/>Prometheus Storage Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/ssl-cert-expiring-soon/>SSL Certificate Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/velero/>Velero Alerts
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="Namespace Level Alerts" menu-label="Namespace Level Alerts"><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/>Namespace Level Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/container/>Container Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/job/>Job Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/persistent-volume-claims/>Persistent Volume Claim Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/pod-not-ready/>Pod Alerts
</gcds-nav-link></gcds-nav-group></gcds-nav-group><gcds-nav-group open-trigger=Appendix menu-label=Appendix><gcds-nav-link href=/team/appendix/>Appendix
</gcds-nav-link><gcds-nav-link href=/team/appendix/acronyms/>Acronyms
</gcds-nav-link><gcds-nav-link href=/team/appendix/lexicon/>Lexicon</gcds-nav-link></gcds-nav-group></gcds-side-nav></aside><section class=mb-400><gcds-heading tag=h1>Alertmanager</gcds-heading>
<gcds-alert alert-role=danger container=full heading="Avis de traduction" hide-close-btn=true hide-role-icon=false is-fixed=false class="hydrated mb-400"><gcds-text>Veuillez noter que ce document est actuellement en cours de développement actif et pourrait être sujet à des révisions. Une fois terminé, il sera entièrement traduit en français et mis à disposition dans sa version finale.</gcds-text>
</gcds-alert><gcds-text character-limit=true><gcds-link href=https://prometheus.io/docs/alerting/latest/alertmanager/>Alertmanager</gcds-link> is used by Prometheus to deduplicate, route, group, silence, and inhibit
<gcds-link href=%28%29>alerts</gcds-link>.</gcds-text>
<gcds-text character-limit=true>A single instance of Alertmanager can receive and manage alerts from multiple different instances of Prometheus. When doing so, it is best to configure the Prometheus instances to add a label to the alerts that they transmit, such as <code>cluster: foo</code> or <code>prometheus: bar</code>, so that the alerts could be differentiated within Alertmanager and its notifications.</gcds-text>
<gcds-text character-limit=true>A single instance of Prometheus can send alerts to one or more instances of Alertmanager, as well as modify or selectively drop alerts before they are transmitted. However, a Prometheus instance cannot send different sets of alerts to different instances of Alertmanager.</gcds-text>
<gcds-heading tag=h2 id=configuration character-limit=true>Configuration</gcds-heading>
<gcds-text character-limit=true>Alertmanager is configured through a YAML file. In the context of the Prometheus Operator, this configuration is expected within a Kubernetes secret, as a base64 value of the key <code>alertmanager.yaml</code>. If notification templates are used, each template should be a separate key-value pair in the data of the same secret, with the template as a base64 value of a key whose name matches the specification in the Alertmanager config. For example, if the Alertmanager config specifies:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>templates</span>:
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#39;*.tmpl&#39;</span>
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#39;*.html&#39;</span>
</span></span></code></pre></div><gcds-text character-limit=true>Then <code>slack.tmpl: &lt;base64 encoded template></code> and <code>email.html: &lt;base64 encoded template></code> are acceptable.</gcds-text>
<gcds-text character-limit=true>This can be done manually by creating a secret with multiple <code>--from-file</code> specifications, or through values in Helm charts that include Alertmanager.</gcds-text>
<gcds-heading tag=h3 id=alert-routing character-limit=true>Alert routing</gcds-heading>
<gcds-text character-limit=true>Routing is done through a series of matches which can be nested: there must be one default <code>route</code>, but that <code>route</code> can have child <code>routes</code>, which can themselves have child <code>routes</code>, and so on.</gcds-text>
<gcds-text character-limit=true>The following example configuration defaults to sending all alerts to the empty default receiver <code>do_not_notify</code>. However, alerts with the labels <code>severity: medium</code> or <code>severity: high</code> instead go to the <code>ms_teams</code> receiver. Then, due to the property <code>continue: true</code>, those with the label <code>severity: high</code> are <em>also</em> sent to the <code>email</code> receiver.</gcds-text><blockquote><gcds-text character-limit=true>If an alert matches to a route without the <code>continue: true</code> property, it is &ldquo;consumed&rdquo; by that route or that route&rsquo;s child routes. That alert will not be transmitted to sibling routes even if it matches their criteria.</gcds-text></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>smtp_smarthost</span>: <span style=color:#e6db74>&#39;&lt;Host&gt;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>smtp_from</span>: <span style=color:#e6db74>&#39;&lt;Do not reply address&gt;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>smtp_auth_username</span>: <span style=color:#e6db74>&#39;&lt;Username&gt;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>smtp_auth_password</span>: <span style=color:#e6db74>&#39;&lt;Password&gt;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>smtp_require_tls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>receivers</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Empty receiver</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>do_not_notify</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ms_teams</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>webhook_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;http://prometheus-msteams:2000/example&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>send_resolved</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>email</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>email_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>to</span>: <span style=color:#e6db74>&#39;&lt;Recipient email(s), seperated by commas if multiple&gt;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>send_resolved</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>html</span>: <span style=color:#e6db74>&#39;{{ template &#34;email.email.html&#34; . }}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>templates</span>:
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#39;*.tmpl&#39;</span>
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#39;*.html&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>group_by</span>: [<span style=color:#e6db74>&#39;cluster&#39;</span>, <span style=color:#e6db74>&#39;alertname&#39;</span>, <span style=color:#e6db74>&#39;namespace&#39;</span>]
</span></span><span style=display:flex><span>  <span style=color:#f92672>group_wait</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>group_interval</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>receiver</span>: <span style=color:#ae81ff>do_not_notify</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>repeat_interval</span>: <span style=color:#ae81ff>168h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match_re</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>medium|high</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>receiver</span>: <span style=color:#ae81ff>ms_teams</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>continue</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match_re</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>high</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>receiver</span>: <span style=color:#ae81ff>email</span>
</span></span></code></pre></div><gcds-text character-limit=true>Note that <code>severity</code> is an example of an arbitrary label which is set on the Prometheus rule defining the alert. Such a label could just as easily be <code>severity: ultramax</code> or <code>colour: blue</code>. It is equally possible to match for combinations of labels, such as:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>match_re</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>medium|high</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>project</span>: <span style=color:#ae81ff>myproject</span>
</span></span></code></pre></div><gcds-heading tag=h3 id=alert-inhibition character-limit=true>Alert inhibition</gcds-heading>
<gcds-text character-limit=true>In addition to routing notifications, the Alertmanager <code>config</code> can be set up to not transmit certain alerts if certain other alerts are firing. <code>inhibition_rules</code> are set at the same indentation level as the base <code>route</code>.</gcds-text>
<gcds-text character-limit=true>For example, per following specification, when there is a PodNotReady and a ContainerWaiting alert for the same pod in the same namespace on the same cluster, only the ContainerWaiting alert will transmit. This is done because <code>ContainerWaiting</code> always causes <code>PodNotReady</code>, so when both are present, <code>PodNotReady</code> is redundant. However, <code>PodNotReady</code> can occur for reasons other than <code>ContainerWaiting</code>.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>inhibit_rules</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>target_match</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>alertname</span>: <span style=color:#e6db74>&#39;PodNotReady&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source_match_re</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>alertname</span>: <span style=color:#e6db74>&#39;ContainerWaiting&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>equal</span>: [<span style=color:#e6db74>&#39;cluster&#39;</span>, <span style=color:#e6db74>&#39;namespace&#39;</span>, <span style=color:#e6db74>&#39;pod&#39;</span>]
</span></span></code></pre></div><gcds-heading tag=h3 id=notification-templates character-limit=true>Notification templates</gcds-heading>
<gcds-text character-limit=true>The following notification templates are available on an as-is basis for reference. They may need to be modified for any relevant syntax updates, specific alert label definitions, and preferences for which labels and functionality to include or exclude.</gcds-text><ul><li><gcds-link href=https://github.com/frazs/prometheus-operator-configs/blob/master/alertmanager-config/email.html>Email</gcds-link></li><li><gcds-link href=https://github.com/frazs/prometheus-operator-configs/blob/master/alertmanager-config/slackcustom.tmpl>Slack</gcds-link></li><li><gcds-link href=https://github.com/frazs/prometheus-operator-configs/blob/master/alertmanager-config/msteams.tmpl>MS Teams</gcds-link> &ndash; not natively supported by Alertmanager and therefore requiring the installation of, and configuraiton within,
<gcds-link href=https://github.com/prometheus-msteams/prometheus-msteams/tree/master/chart/prometheus-msteams>prometheus-msteams</gcds-link></li></ul><gcds-heading tag=h3 id=configuration-references character-limit=true>Configuration references</gcds-heading><ul><li>See the
<gcds-link href=https://prometheus.io/docs/alerting/0.21/configuration/>Alertmanger configuration documentation</gcds-link> for a full list of possibilities.</li><li>Test your route logic using the
<gcds-link href=https://www.prometheus.io/webtools/alerting/routing-tree-editor/>Routing tree editor</gcds-link> web tool. For simplicity and privacy, all that is required to paste in is the <code>route</code> and <code>receivers</code> block. Furthermore, the <code>receivers</code> block can be truncated to contain only the <code>- name: foo</code> lines.</li></ul><gcds-heading tag=h2 id=alert-silencing character-limit=true>Alert Silencing</gcds-heading>
<gcds-text character-limit=true>In some cases, an alert for a particular issue can fire repeatedly or flap. Here are a few common examples:</gcds-text><ul><li>The consumption of a resource, such as disk or pod capacity, bounces above and below the alerting threshold.</li><li>A low-priority issue persists for longer than Alertmanager’s data retention period, forcing Alertmanager to recreate the alert.</li><li>An outage is not continuous, resolving itself for a few minutes or hours at a time only to reoccur.</li></ul><gcds-text character-limit=true>Alerting rules can be designed to reduce flapping. But flapping cannot always be eliminated. Mitigations must be balanced against the accuracy and promptness of alerts, preferring a false positive over a false negative.</gcds-text>
<gcds-text character-limit=true>A repeating alert can be silenced by creating a corresponding Silence in the Alertmanager UI. To facilitate this process, alert notifications can contain a Silence link that will pre-fill the Silence creation form with regex matchers specific to the alert and its origin. These matchers can be removed or modified to make the Silence more general.</gcds-text>
<gcds-text character-limit=true>Silences are created with a duration/end-time and can also be removed (&ldquo;expired&rdquo;) at any time. A list of all Silences can be viewed in the Alertmanager UI.</gcds-text>
<gcds-text character-limit=true>Note that silences also apply to alert resolution notifications. Do not apply a silence if you want to use these notifications to track the times at which an ongoing issue self-resolves.</gcds-text>
<gcds-heading tag=h2 id=creating-alerts character-limit=true>Creating Alerts</gcds-heading>
<gcds-text character-limit=true>A Prometheus Alert is one of two types of Prometheus Rules. To define an Alert, it is important to first understand the core components of a Rule: metrics and PromQL (Prometheus Query Language) queries.</gcds-text>
<gcds-heading tag=h3 id=metrics-and-exporters character-limit=true>Metrics and Exporters</gcds-heading>
<gcds-text character-limit=true>First and foremost, the relevant metrics must be available to Prometheus. If what you are trying to monitor with Prometheus has not been
<gcds-link href=https://prometheus.io/docs/practices/instrumentation/>instrumented</gcds-link> to natively expose metrics in a format that Prometheus can read, this requires creating or installing a metric exporter.</gcds-text><ul><li><gcds-link href=https://prometheus.io/docs/instrumenting/exporters/>Sample list of exporters</gcds-link></li><li><gcds-link href=https://prometheus.io/docs/instrumenting/writing_exporters/>Guide to writing exporters</gcds-link></li></ul><gcds-text character-limit=true>Whether the metrics are native or generated by an exporter, configurations must be put in place for them to be picked up. When using the
<gcds-link href=/team/monitoring-alerts/prometheus-operator/>Prometheus Operator</gcds-link>, such configurations can include creating or enabling ServiceMonitors or PodMonitors with labels that the Prometheus custom resource selects for.</gcds-text>
<gcds-heading tag=h3 id=querying-metrics character-limit=true>Querying metrics</gcds-heading>
<gcds-text character-limit=true>Once metrics are available, developing a Prometheus query is the core of making a Prometheus Alert. Refer to the 
<gcds-link href=https://prometheus.io/docs/prometheus/latest/querying/basics/>Prometheus Documentation</gcds-link> for understanding and building queries, and test them out by executing them in any running instance of Prometheus.</gcds-text>
<gcds-text character-limit=true>Some metrics are useful for their values. Others are useful for their informative labels, and will typically have a &ldquo;value&rdquo; of 1. For any query with unique results for what is being measured, the 
<gcds-link href=https://prometheus.io/docs/prometheus/latest/querying/operators/#aggregation-operators>aggregation opperators</gcds-link> <code>sum by</code> and <code>sum without</code> are especially useful for trimming labels to return only relevant and secure information.</gcds-text>
<gcds-text character-limit=true>For example, the query <code>node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes</code> returns the available memory on nodes and is composed of two metrics made available by the Prometheus Node Exporter. A simple alert could correspond to the query <code>node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 &lt; 15</code>. But the labels for these metrics only identify the node by its IP address (<code>instance</code>), which is not easy to follow. How could we get the node name instead?</gcds-text>
<gcds-text character-limit=true>Fortunately, both the node <code>instance</code> and <code>nodename</code> are available in another metric, <code>node_uname_info</code>. Since <code>node_uname_info</code> is an informative label metric that always has a &ldquo;value&rdquo; of <code>1</code>, we can take advantage of the arithmetic operator <code>*</code> to join this information:  <code>node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes</code> <strong><code>* on(instance) group_left(nodename) node_uname_info</code></strong>.</gcds-text>
<gcds-text character-limit=true>Now we can use <code>sum by</code> to return only the <code>nodename</code>: <strong><code>sum by (nodename)</code></strong> <code>(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * on(instance,job) group_left(nodename) node_uname_info)</code>, perhaps with a * 100 &lt; 15  at the end for an alert that will report on nodes under 15% memory.</gcds-text>
<gcds-heading tag=h3 id=defining-prometheus-rules character-limit=true>Defining Prometheus Rules</gcds-heading>
<gcds-text character-limit=true>There are two kinds of Prometheus Rules: <strong>Records</strong> and <strong>Alerts</strong>.</gcds-text>
<gcds-text character-limit=true><strong>Records</strong> are very simple. They consist of a name and an expression corresponding to a query. This name can then be queried as if it was a metric, which is useful for organizing and pre-computing parts of complex queries.</gcds-text>
<gcds-text character-limit=true>For example:</gcds-text><ul><li><code>sum(kube_node_status_allocatable_pods * on (node) group_left(label_agentpool) kube_node_labels) by (label_agentpool)</code> is recorded as <code>nodepool_allocatable_pods</code></li><li><code>sum(kube_pod_info * on (node) group_left(label_agentpool) kube_node_labels) by (label_agentpool)</code> is recorded as <code>nodepool_allocated_pods</code></li><li>This simplifies constructing a query for the proportion of pods allocated in a nodepool into <code>nodepool_allocated_pods/nodepool_allocatable_pods</code></li></ul><gcds-text character-limit=true><strong>Alerts</strong> also start with a name and an expression. However, the expression for an Alert will almost always end with some form of
<gcds-link href=https://prometheus.io/docs/prometheus/latest/querying/operators/#comparison-binary-operators>comparison binary operator</gcds-link>, which is typically not the case for a Record.</gcds-text>
<gcds-text character-limit=true>Alerts are further defined by a duration, which is how long an expression must be valid for the alert to go from<code>Pending</code> to <code>Firing</code> (e.g. &ldquo;less than 15% CPU left for more than 2 minutes&rdquo;), any additional labels (such as <code>severity</code>), and any additional <code>annotations</code> such as a descriptive <code>message</code> and/or a <code>runbook</code> link.</gcds-text>
<gcds-heading tag=h4 id=examples character-limit=true>Examples</gcds-heading>
<gcds-text character-limit=true>Many examples of Prometheus Alerts are available at 
<gcds-link href=https://awesome-prometheus-alerts.grep.to/>Awesome Prometheus Alerts</gcds-link>. These alerts should be used as references and starting points: they assume the presence of any required exporters, do not omit any labels, and may have arbitrary thresholds, formats, and severities. For example, annotations are split into a <code>summary</code> and a <code>description</code> instead of a single <code>message</code>.</gcds-text>
<gcds-text character-limit=true>It is also important to calibrate the sensitivity of alerts to the scope and scale of the environment being monitored. The level of detail appropriate for monitoring a single application may be too noisy for the monitoring of a namespace, which can in turn be too noisy for the monitoring of one or more clusters.</gcds-text>
<gcds-heading tag=h4 id=picking-up-prometheus-rules character-limit=true>Picking up Prometheus Rules</gcds-heading>
<gcds-text character-limit=true>Once Prometheus Rules are defined, they must be picked up by the relevant Prometheus instance.</gcds-text>
<gcds-text character-limit=true>In a standalone installation of Prometheus, rules are written in YAML files and which are specified under <code>rule_files</code> in the
<gcds-link href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/>Prometheus configuration</gcds-link>. The
<gcds-link href=https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus>Prometheus Helm chart</gcds-link> facilitates this by allowing the entry of rules as
<gcds-link href=https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus/values.yaml>Helm values</gcds-link> <code>alerting_rules.yml</code> and <code>recording_rules.yml</code>.</gcds-text>
<gcds-text character-limit=true>Alternatively, the
<gcds-link href=/team/monitoring-alerts/prometheus-operator/>Prometheus Operator</gcds-link> facilitates the management of Prometheus Rules via a PrometheusRule Custom Resource Definition. There is no distinction made between Alerting and Recording rules, and they may coexist within the same PrometheusRule manifest.</gcds-text>
<gcds-text character-limit=true>A PrometheusRule custom resource defines one or more Prometheus Rules, which can further be categorized into groups.
<gcds-link href=https://github.com/frazs/prometheus-operator-configs/blob/master/general-cluster-alerts.yaml>See an example</gcds-link>.</gcds-text>
<gcds-text character-limit=true>As with all other Kubernetes resources, PrometheusRules can be:</gcds-text><ul><li>Added with commands such as <code>kubectl -n mynamespace -f myalerts.yaml</code></li><li>Removed with <code>kubectl -n mynamespace delete prometheusrule my-alerts</code> (use <code>kubectl -n mynamespace get prometheusrules</code> to confirm the resource name)</li><li>Updated by editing the yaml file and applying it again, whether manually or through any configuration-as-code management process.</li></ul><gcds-text character-limit=true>The default configuration of the Prometheus instance installed by the
<gcds-link href=https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack>Kube-Prometheus-Stack Helm chart</gcds-link> (which installs the Prometheus Operator alongside supporting components) picks up all PrometheusRules with the label <code>release: kube-prometheus-stack</code>, or the name of the Helm release corresponding to kube-prometheus-stack if a different name was selected. This label must be on the PrometheusRule resource and should not be confused with labels on any Rules within.</gcds-text>
<gcds-text character-limit=true>This behaviour can be modified to look for one or more different labels, as well as to specify that PrometheusRules are only to be picked up from specific namespaces.</gcds-text>
<gcds-text character-limit=true>It is also possible to run multiple Prometheus instances with different criteria for which rules they pick up. These criteria are within the specification of the Prometheus custom resource(s) managed by the Prometheus Operator.</gcds-text>
<gcds-date-modified lang=en>0001-01-01</gcds-date-modified></section></gcds-grid></gcds-container></main><gcds-footer lang=en display=compact contextual-heading=Aurora contextual-links='{ "Contact us": "/contact","Report an issue": "https://github.com/gccloudone/aurora/issues/new/choose","About us": "/about" }'></gcds-footer><script src=https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js></script><script>const style=document.createElement("style");style.innerHTML=`
    .glightbox-container.glightbox-custom-white-bg img {
      background: white !important;
    }
  `,document.head.appendChild(style);const lightbox=GLightbox({openEffect:"zoom",closeEffect:"fade",skin:"custom-white-bg"})</script></body></html>