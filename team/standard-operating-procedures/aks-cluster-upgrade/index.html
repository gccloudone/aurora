<!doctype html><html dir=ltr lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>Performing an AKS Cluster Upgrade | Aurora
</title><link rel=icon href=/favicon.ico type=image/x-icon><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css as=style crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.10.0/dist/gcds-utility.min.css><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.42.0/dist/gcds/gcds.css><script async type=module src=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.42.0/dist/gcds/gcds.esm.js></script><link rel=stylesheet href=/scss/main.css><link rel=stylesheet href=/scss/custom.css><style>html{font-size:16px}body{font-size:var(--gcds-font-sizes-text);line-height:var(--gcds-line-heights-text);color:var(--gcds-color-grayscale-1000);font-family:var(--gcds-font-families-body),sans-serif;margin:0;animation:fade .05s forwards ease-in-out}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css></head><body style=margin:0 class=character-limit><main><gcds-container centered size=md><gcds-text size=caption style="text-align: center;"><strong>Alpha</strong>&nbsp;&nbsp;This is an experimental service.</gcds-text>
</gcds-container><gcds-header lang=en lang-href signature-variant=colour skip-to-href=#><gcds-search lang=en slot=search action=/sr/srb.html placeholder=Aurora></gcds-search><gcds-top-nav slot=menu label="Top navigation" alignment=right><gcds-nav-link href=/ slot=home>GC Cloud One: Aurora
</gcds-nav-link><gcds-nav-group open-trigger=Platform menu-label=Platform><gcds-nav-link href=/roadmap>Roadmap
</gcds-nav-link><gcds-nav-link href=/components>Components
</gcds-nav-link><gcds-nav-link href=/vision>Vision
</gcds-nav-link><gcds-nav-link href=/architecture>Architecture
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="User Guides" menu-label="User Guides"><gcds-nav-link href=/user-guides/onboarding>Onboarding
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Team menu-label=Team><gcds-nav-link href=/team/sop>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/>Monitoring
</gcds-nav-link><gcds-nav-link href=/team/appendix>Appendix
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Community menu-label=Community><gcds-nav-link href=/get-involved>Get involved
</gcds-nav-link><gcds-nav-link href=/rules-of-engagement>Rules of Engagement
</gcds-nav-link><gcds-nav-link href=/technical-advisory-group>Technical Advisory Group
</gcds-nav-link></gcds-nav-group></gcds-top-nav><gcds-breadcrumbs slot=breadcrumb><gcds-breadcrumbs-item href="https://hosting-services-hebergement.canada.ca/s/gc-cloud-one?language=en_US">GC Cloud One</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/>Aurora</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/>Team Guide</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/standard-operating-procedures/>Standard Operating Procedures</gcds-breadcrumbs-item>
</gcds-breadcrumbs></gcds-header><gcds-container size=xl main-container centered tag=main><gcds-grid tag=section columns=1fr columns-desktop="
        1fr 3fr
      " align-items=start class=hydrated><aside role=complementary><gcds-side-nav label="Team Guide"><gcds-nav-link href=/team/>Team Guide
</gcds-nav-link><gcds-nav-group open-trigger="Standard Operating Procedures" menu-label="Standard Operating Procedures" open><gcds-nav-link href=/team/standard-operating-procedures/>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/aks-cluster-upgrade/ current=true>AKS Cluster Upgrade
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/ssl-cert-issuance/>SSL Cert Issuance
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/issue-tracking/>Issue Tracking
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/adding-components-aurora-platform-chart/>Adding components to Aurora Platform Charts
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/backup-disaster-recovery/>Backup and Disaster Recovery
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/bootstrap-cluster/>Bootstrap Cluster
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/infrastructure-and-configuration-management/>Infrastructure and Configuration Management
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/issue-naming/>Issue and PR Naming Conventions
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/enterprise-landing-zone/>Onboarding process for the Enterprise Landing Zone
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="Monitoring and Alerting" menu-label="Monitoring and Alerting"><gcds-nav-link href=/team/monitoring-alerts/>Monitoring and Alerting
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/prometheus/>Prometheus
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/prometheus-operator/>Prometheus Operator
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alertmanager/>Alertmanager
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/blackbox-exporter/>Blackbox Exporter
</gcds-nav-link><gcds-nav-group open-trigger="Cluster Level Alerts" menu-label="Cluster Level Alerts"><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/>Cluster Level Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/cert-manager/>Cert Manager Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/dns/>DNS Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/node/>Node Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/node-pool-pod-capacity/>Node Pool Capacity Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/probe-failure/>Probe Failure Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/prometheus-storage-low/>Prometheus Storage Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/ssl-cert-expiring-soon/>SSL Certificate Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-cluster-level/velero/>Velero Alerts
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger="Namespace Level Alerts" menu-label="Namespace Level Alerts"><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/>Namespace Level Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/container/>Container Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/job/>Job Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/persistent-volume-claims/>Persistent Volume Claim Alerts
</gcds-nav-link><gcds-nav-link href=/team/monitoring-alerts/alert-namespace-level/pod-not-ready/>Pod Alerts
</gcds-nav-link></gcds-nav-group></gcds-nav-group><gcds-nav-group open-trigger=Appendix menu-label=Appendix><gcds-nav-link href=/team/appendix/>Appendix
</gcds-nav-link><gcds-nav-link href=/team/appendix/acronyms/>Acronyms
</gcds-nav-link><gcds-nav-link href=/team/appendix/lexicon/>Lexicon</gcds-nav-link></gcds-nav-group></gcds-side-nav></aside><section class=mb-400><gcds-heading tag=h1>Performing an AKS Cluster Upgrade</gcds-heading>
<gcds-alert alert-role=danger container=full heading="Avis de traduction" hide-close-btn=true hide-role-icon=false is-fixed=false class="hydrated mb-400"><gcds-text>Veuillez noter que ce document est actuellement en cours de développement actif et pourrait être sujet à des révisions. Une fois terminé, il sera entièrement traduit en français et mis à disposition dans sa version finale.</gcds-text>
</gcds-alert><gcds-text character-limit=true>This document outlines the process for upgrading an AKS cluster.</gcds-text>
<gcds-heading tag=h2 id=preparing-your-environment character-limit=true>Preparing your environment<gcds-link href=#preparing-your-environment class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Ensure the following command line tools below are installed & are up-to-date.</gcds-text><ul><li><gcds-text character-limit=true><input disabled type=checkbox> <strong><gcds-link href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/>kubectl</gcds-link></strong><br>Ensure <code>kubectl</code> is within 1 minor version of the new cluster version.</gcds-text></li><li><gcds-text character-limit=true><input disabled type=checkbox> <strong><gcds-link href=https://learn.microsoft.com/cli/azure/install-azure-cli>Azure CLI</gcds-link></strong></gcds-text></li><li><gcds-text character-limit=true><input disabled type=checkbox> <strong><gcds-link href=https://github.com/vmware-tanzu/velero/releases>velero</gcds-link></strong><br>The version of velero should match the version of velero used in the target cluster.</gcds-text></li><li><gcds-text character-limit=true><input disabled type=checkbox> <strong><gcds-link href=https://jqlang.github.io/jq/download/>jq</gcds-link></strong><br>Used for exporting and processing pod information.</gcds-text></li><li><gcds-text character-limit=true><input disabled type=checkbox> <strong><gcds-link href=https://pluto.docs.fairwinds.com/installation/>pluto</gcds-link></strong><br>Detects deprecated and removed Kubernetes API versions.</gcds-text></li><li><gcds-text character-limit=true><input disabled type=checkbox> (Optional) <strong><gcds-link href=https://asdf-vm.com/guide/getting-started.html>asdf</gcds-link></strong><br>Used to upgrade multiple Kubernetes clusters that are more than 2 minor versions apart from each other. Manages multiple concurrent versions of kubectl.</gcds-text></li></ul><gcds-text character-limit=true>Ensure that your environment will not be automatically shutdown during the maintenance period.</gcds-text>
<gcds-heading tag=h2 id=upgrading-the-cluster character-limit=true>Upgrading the cluster<gcds-link href=#upgrading-the-cluster class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true><strong>Before following the procedure, ensure your environment is setup as described in
<gcds-link href=#preparing-your-environment>Preparing your environment</gcds-link> & read the
<gcds-link href=#troubleshooting>Troubleshooting</gcds-link> section prior to carrying out the upgrade procedure.</strong></gcds-text>
<gcds-heading tag=h3 id=1-verify-deprecated-apis character-limit=true>1. Verify deprecated APIs<gcds-link href=#1-verify-deprecated-apis class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Use pluto to check if there are any deprecated APIs in the new cluster version.</gcds-text>
<gcds-text character-limit=true><code>pluto detect-all-in-cluster k8s=new-cluster-version</code></gcds-text>
<gcds-text character-limit=true>Record any deprecated APIs on the JIRA ticket & make sure the manifest is using the new API version before continuing with the upgrade.</gcds-text>
<gcds-heading tag=h3 id=2-export-information-of-pods-that-are-not-succeeded-or-running character-limit=true>2. Export information of Pods that are not <strong>Succeeded or Running</strong><gcds-link href=#2-export-information-of-pods-that-are-not-succeeded-or-running class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Run the following two commands to export the information of Pods & containers that may be in a bad state:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -A -o json | jq <span style=color:#e6db74>&#39;.items[] | select(.status.phase|test(&#34;Succeeded|Running&#34;)|not) | {namespace: .metadata.namespace, name: .metadata.name, phase: .status.phase}&#39;</span> | jq <span style=color:#e6db74>&#39;{pods:[inputs]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get po -A | grep -v Running | grep -v Completed
</span></span></code></pre></div><gcds-text character-limit=true>Add the output of this command to the Jira ticket for this cluster upgrade, along with any easily available supporting information (such as error messages in the events of those pods).</gcds-text>
<gcds-heading tag=h3 id=3-back-up-the-cluster character-limit=true>3. Back up the Cluster<gcds-link href=#3-back-up-the-cluster class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>To allow for restoration in the event of a catastrophic failure during the upgrade process, take a full snapshot of the cluster (resources and disks) using Velero.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Get the name of the snapshot location for the current cluster</span>
</span></span><span style=display:flex><span>velero -n velero-system snapshot-location get
</span></span><span style=display:flex><span><span style=color:#75715e># Take a backup</span>
</span></span><span style=display:flex><span>velero -n velero-system backup create backup-YYYYMMDDHHMM --include-cluster-resources --volume-snapshot-locations $SNAPSHOT_LOCATION_NAME --ttl 168h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Monitor the backup (watch the Phase indicator: Completed or PartiallyFailed [normal])</span>
</span></span><span style=display:flex><span>velero -n velero-system backup describe backup-YYYYMMDDHHMM
</span></span></code></pre></div><gcds-heading tag=h3 id=4-upgrade-control-plane character-limit=true>4. Upgrade Control Plane<gcds-link href=#4-upgrade-control-plane class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Login through the <code>az</code> cli and set your subscription to the subscription the target cluster lives in.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az login
</span></span><span style=display:flex><span>az account list -o table
</span></span><span style=display:flex><span>az account set --subscription &lt;Subscription Name or ID&gt;
</span></span></code></pre></div><gcds-text character-limit=true>Then, get the available upgrade versions:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az aks get-versions -l canadacentral -o table
</span></span></code></pre></div><gcds-text character-limit=true>Set the below local variables that will be used throughout the upgrade:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>CLUSTER_RESOURCE_GROUP<span style=color:#f92672>=</span>&lt;Name of cluster resource group&gt;
</span></span><span style=display:flex><span>CLUSTER_NAME<span style=color:#f92672>=</span>&lt;Name of cluster&gt;
</span></span><span style=display:flex><span>KUBERNETES_VERSION<span style=color:#f92672>=</span>&lt;New kubernetes upgrade version&gt;
</span></span></code></pre></div><gcds-text character-limit=true>Finally, upgrade the control plane to the latest available patch version for the major version that you are upgrading to:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az aks upgrade -g $CLUSTER_RESOURCE_GROUP -n $CLUSTER_NAME --control-plane-only -k $KUBERNETES_VERSION --no-wait
</span></span></code></pre></div><gcds-text character-limit=true>At this point, as well as later when upgrading the data plane, there is occasionally a glitch where the following message is displayed:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>The cluster is already on version &lt;old kubernetes version&gt; and is not in a failed state. No operations will occur when upgrading to the same version <span style=color:#66d9ef>if</span> the cluster is not in a failed state. <span style=color:#f92672>(</span>y/n<span style=color:#f92672>)</span>
</span></span></code></pre></div><gcds-text character-limit=true>If you encounter it, proceed with <code>y</code>.</gcds-text>
<gcds-text character-limit=true>Confirm that the control plane has been updated.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl version
</span></span></code></pre></div><gcds-heading tag=h3 id=5-upgrade-node-pools character-limit=true>5. Upgrade Node Pools<gcds-link href=#5-upgrade-node-pools class=pilcrow>¶</gcds-link></gcds-heading><blockquote><gcds-text character-limit=true><strong>Note</strong>: The upgrade process will cause all workloads to be evicted from old nodes and rescheduled to newer nodes. This process will respect any <code>PodDisruptionBudgets</code> which target pods.</gcds-text></blockquote><gcds-text character-limit=true>List the node pools:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az aks nodepool list -g $CLUSTER_RESOURCE_GROUP --cluster-name $CLUSTER_NAME -o table
</span></span></code></pre></div><gcds-text character-limit=true>For each node pool run the following, using the same Kubernetes version as the control plane.</gcds-text>
<gcds-alert alert-role=danger container=full heading=Danger hide-close-btn=true hide-role-icon=false is-fixed=false class="hydrated mb-400"><gcds-text>DO NOT upgrade nodepools in different Availability Zones (AZs) at the same time.</gcds-text></gcds-alert><blockquote><gcds-text character-limit=true><strong>Note</strong>: You may optionally decide to upgrade multiple nodepools <strong>within the same AZ</strong> at the same time to speed up the upgrade process.
For example, if there is a gateway1, system1, general1 <strong>AND</strong> a gateway2, system2, and general2 nodepools, you can upgrade all the Zone 1 nodepools first at the same time (gateway1, system1, general1) before moving onto upgrading the Zone 2 nodepools that being gateway2, system2, and general2.</gcds-text></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az aks nodepool upgrade -g $CLUSTER_RESOURCE_GROUP --cluster-name $CLUSTER_NAME -k $KUBERNETES_VERSION --no-wait -n &lt;Name of node pool&gt;
</span></span></code></pre></div><gcds-text character-limit=true>Continue to check on the status of the upgrade by running:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az aks nodepool list -g $CLUSTER_RESOURCE_GROUP --cluster-name $CLUSTER_NAME -o table
</span></span></code></pre></div><gcds-text character-limit=true>Continuously check the status of the nodes to ensure they are being cordoned & drained. You should also be seeing new nodes come in with the new Kubernetes version.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><gcds-text character-limit=true><strong>Refer to
<gcds-link href=#nodepool-stuck-in-updating-state-and-node-not-being-deleted>Nodepool stuck in Updating State and Node not being deleted</gcds-link> if Nodes are stuck in <code>SchedulingDisabled</code> for longer than 10 minutes.</strong></gcds-text>
<gcds-text character-limit=true>Continue to the next section once the ProvisioningState changes from <code>Updating</code> to <code>Succeeded</code> for all nodepools & reflect the new Kubernetes version.</gcds-text>
<gcds-heading tag=h3 id=6-ensure-workloads-are-healthy character-limit=true>6. Ensure Workloads are Healthy<gcds-link href=#6-ensure-workloads-are-healthy class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Confirm that workloads are functioning. Re-run the commands described in
<gcds-link href=#2-export-information-of-pods-that-are-not-succeeded-or-running>this section</gcds-link>. Compare the output of the commands before & after the upgrade & ensure that any workloads which were not broken before the update are fixed.</gcds-text>
<gcds-heading tag=h3 id=7-update-the-infrastructure-as-code character-limit=true>7. Update the Infrastructure-as-Code<gcds-link href=#7-update-the-infrastructure-as-code class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Update the <code>kubernetes_version</code> variable in the terraform file instantiating the
<gcds-link href=https://github.com/gccloudone-aurora-iac/terraform-aurora-azure-environment>terraform-aurora-azure-environment</gcds-link> module.</gcds-text><hr><gcds-heading tag=h2 id=troubleshooting character-limit=true>Troubleshooting<gcds-link href=#troubleshooting class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Check the <code>Activity Log</code> for <code>Create or Update Agent Pool</code> errors within the Azure portal, where details may be available in the <code>JSON</code> panel.</gcds-text>
<gcds-heading tag=h3 id=nodepool-stuck-in-updating-state-and-node-not-being-deleted character-limit=true>Nodepool stuck in Updating State and Node not being deleted<gcds-link href=#nodepool-stuck-in-updating-state-and-node-not-being-deleted class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>Check if there is a PDB preventing a node from draining:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get events -A --sort-by<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;.metadata.creationTimestamp&#39;</span> | grep pdb
</span></span></code></pre></div><gcds-text character-limit=true>The drain process will respect any PodDisruptionBudget (PDB) in place. Respecting a PDB can take time in order to ensure that a sufficient number of replicas has been rescheduled before draining the node. This can result in the drain getting stuck if a PDB specifies a minimum number of replicas that is equal to or greater than the total number of replicas on the node, preventing any rescheduling.</gcds-text>
<gcds-text character-limit=true>There are multiple options to address this:</gcds-text><ul><li><gcds-text character-limit=true>Increase the replicas of the pod controller if possible</gcds-text></li><li><gcds-text character-limit=true>Edit the PDB to decrease the minimum number of pods that need to be available</gcds-text></li><li><gcds-text character-limit=true>If all else fails, or it is a Dev or NonProd environment, manually delete the stuck pod(s)</gcds-text></li><li><gcds-text character-limit=true>Look through the pods on any node that has been in <code>SchedulingDisabled</code> for an unusually long time to check for error events or stuck PodDisruptionBudgets.</gcds-text></li></ul><gcds-text character-limit=true>Make a note of any misconfigured PDBs so that these issues can be addressed prior to further Kubernetes upgrades. For a long term solution, a Gatekeeper policy should be developed to prevent such misconfigured PDBs.</gcds-text>
<gcds-heading tag=h3 id=availability-zone-issues character-limit=true>Availability Zone Issues<gcds-link href=#availability-zone-issues class=pilcrow>¶</gcds-link></gcds-heading>
<gcds-text character-limit=true>If you encounter Persistent Volume mounting errors reporting that the volume is in an incompatible Availability Zone, ensure that a
<gcds-link href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector>nodeSelector</gcds-link> or
<gcds-link href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity>nodeAffinity</gcds-link> configuration is in place on the relevant pod controller such that it will match the label key <code>topology.kubernetes.io/zone</code> with the value of the zone requested in the error message (provided that nodes with such an availability zone exist).</gcds-text>
<gcds-text character-limit=true>For an immediate hotfix to move a pod into a different node in the same node pool:</gcds-text><ul><li>Cordon all nodes in that node pool that have a <code>topology.kubernetes.io/zone</code> label value different than the requested one, leaving only the node(s) with the correct zone</li><li>Delete the pod</li><li>Once the pod has rescheduled onto a node in the appropriate availability zone, uncordon the previously cordoned nodes</li></ul><gcds-text character-limit=true>In exceptional cases, nodeAffinity configurations can be applied directly onto Persistent Volumes.</gcds-text>
<gcds-alert alert-role=warning container=full heading=Warning hide-close-btn=true hide-role-icon=false is-fixed=false class="hydrated mb-400"><gcds-text>Persistent Volume nodeAffinities are immutable. Ensure caution when setting them and set persistentVolumeReclaimPolicy to Retain if you need to delete and recreate the PV/PVC.</gcds-text>
</gcds-alert><gcds-date-modified lang=en>2026-02-06</gcds-date-modified></section></gcds-grid></gcds-container></main><gcds-footer lang=en display=compact contextual-heading=Aurora contextual-links='{ "Contact us": "/contact","Report an issue": "https://github.com/gccloudone/aurora/issues/new/choose","About us": "/about" }'></gcds-footer><script src=https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js></script><script>const style=document.createElement("style");style.innerHTML=`
    .glightbox-container.glightbox-custom-white-bg img {
      background: white !important;
    }
  `,document.head.appendChild(style);const lightbox=GLightbox({openEffect:"zoom",closeEffect:"fade",skin:"custom-white-bg"})</script></body></html>