<!doctype html><html dir=ltr lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=5"><title>Bootstrap Cluster | Aurora
</title><link rel=icon href=/favicon.ico type=image/x-icon><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css as=style crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.9.3/dist/gcds-utility.min.css><link rel=stylesheet href=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.41.0/dist/gcds/gcds.css><script async type=module src=https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.41.0/dist/gcds/gcds.esm.js></script><link rel=stylesheet href=/scss/main.css><link rel=stylesheet href=/scss/custom.css><style>html{font-size:16px}body{font-size:var(--gcds-font-sizes-text);line-height:var(--gcds-line-heights-text);color:var(--gcds-color-grayscale-1000);font-family:var(--gcds-font-families-body),sans-serif;margin:0;animation:fade .05s forwards ease-in-out}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css></head><body style=margin:0><main><gcds-container centered size=md><gcds-text size=caption style="text-align: center;"><strong>Alpha</strong>&nbsp;&nbsp;This is an experimental service.</gcds-text>
</gcds-container><gcds-header lang=en lang-href signature-variant=colour skip-to-href=#><gcds-search lang=en slot=search action=/sr/srb.html placeholder=Aurora></gcds-search><gcds-top-nav slot=menu label="Top navigation" alignment=right><gcds-nav-link href=/ slot=home>GC Cloud One: Aurora
</gcds-nav-link><gcds-nav-group open-trigger=Platform menu-label=Platform><gcds-nav-link href=/proposal>Proposal
</gcds-nav-link><gcds-nav-link href=/vision>Vision
</gcds-nav-link><gcds-nav-link href=/architecture>Architecture
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Team menu-label=Team><gcds-nav-link href=/team/sop>Standard Operating Procedures
</gcds-nav-link></gcds-nav-group><gcds-nav-group open-trigger=Community menu-label=Community><gcds-nav-link href=/get-involved>Get involved
</gcds-nav-link><gcds-nav-link href=/rules-of-engagement>Rules of Engagement
</gcds-nav-link><gcds-nav-link href=/technical-advisory-group>Technical Advisory Group
</gcds-nav-link></gcds-nav-group><gcds-nav-link href=/contact slot>Contact us
</gcds-nav-link></gcds-top-nav><gcds-breadcrumbs slot=breadcrumb><gcds-breadcrumbs-item href=https://gccloudone.ca>GC Cloud One</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/>Aurora</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/>Team Guide</gcds-breadcrumbs-item>
<gcds-breadcrumbs-item href=/team/standard-operating-procedures/>Standard Operating Procedures</gcds-breadcrumbs-item>
</gcds-breadcrumbs></gcds-header><gcds-container size=xl main-container centered tag=main><gcds-grid tag=section columns=1fr columns-desktop="
        1fr 3fr
      " align-items=start class=hydrated><aside role=complementary><gcds-side-nav label="Team Guide"><gcds-nav-link href=/team/>Team Guide
</gcds-nav-link><gcds-nav-group open-trigger="Standard Operating Procedures" menu-label="Standard Operating Procedures" open><gcds-nav-link href=/team/standard-operating-procedures/>Standard Operating Procedures
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/backup-disaster-recovery/>Backup Disaster Recovery Testing Procedure
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/issue-naming/>Issue & PR Naming Conventions
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/infrastructure-and-configuration-management/>Infrastructure and Configuration Management
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/landing-zone/>Enterprise Landing Zone
</gcds-nav-link><gcds-nav-link href=/team/standard-operating-procedures/bootstrap-cluster/ current=true>Bootstrap Cluster</gcds-nav-link></gcds-nav-group></gcds-side-nav></aside><section class=mb-400><gcds-heading tag=h1>Bootstrap Cluster</gcds-heading>
<gcds-fieldset fieldset-id=field-toc legend class=mb-400><nav id=TableOfContents><ol><li><a href=#pre-requisites>Pre-requisites</a><ol><li><a href=#managed-service-identity-msi>Managed Service Identity (MSI)</a></li></ol></li><li><a href=#bootstrap-cluster>Bootstrap Cluster</a><ol><li><a href=#setup>Setup</a></li><li><a href=#retrieve-kubeconfig-context>Retrieve Kubeconfig context</a></li><li><a href=#custom-ca>Custom CA</a></li><li><a href=#transfer-control>Transfer Control</a><ol><li><a href=#custom-ca-1>Custom CA</a></li><li><a href=#workaround>Workaround</a></li></ol></li><li><a href=#cleanup>Cleanup</a></li></ol></li></ol></nav></gcds-fieldset><gcds-alert alert-role=danger container=full heading="Avis de traduction" hide-close-btn=true hide-role-icon=false is-fixed=false class="hydrated mb-400"><gcds-text>Veuillez noter que ce document est actuellement en cours de développement actif et pourrait être sujet à des révisions. Une fois terminé, il sera entièrement traduit en français et mis à disposition dans sa version finale.</gcds-text>
</gcds-alert><gcds-text character-limit=false>This guide provides instructions for setting up a k3s bootstrap cluster (a process tested in Windows Subsystem for Linux or WSL), deploying Argo CD, and transferring control to a remote Kubernetes cluster. This allows you to shift the management from the k3s instance to your designated target cluster.</gcds-text>
<gcds-text character-limit=false>It&rsquo;s critical because the target cluster initially lacks the cilium networking setup, however, k3s can facilitate the establishment of a full platform within the remote Kubernetes cluster.</gcds-text>
<gcds-text character-limit=false>Finally, Argo CD can also be configured to be deployed within your target cluster, making the usage of this bootstrap usually a one time occurrence to solve the chicken and egg bootstrapping issue.</gcds-text>
<gcds-heading tag=h2 id=pre-requisites character-limit=false>Pre-requisites</gcds-heading><ul><li>WSL</li><li>JQ</li><li>Access to Key Vault secrets through MSI</li></ul><gcds-text character-limit=false>Additionally you should ensure that a .env file is created based on the .env.example file.</gcds-text>
<gcds-text character-limit=false>Finally that the argocd-instance.yaml under the base folder is successully configured.</gcds-text>
<gcds-heading tag=h3 id=managed-service-identity-msi character-limit=false>Managed Service Identity (MSI)</gcds-heading>
<gcds-text character-limit=false>The fundamental requirement for the successful operation of Argo CD in this context is the Managed Service Identity (MSI).</gcds-text>
<gcds-text character-limit=false>The MSI lets Argo CD read our key vault secrets which has all of the secrets, service principals, and stuff necessary for argo to run whether on the k3s instance or the target cluster itself.</gcds-text>
<gcds-text character-limit=false>An MSI for ArgoCD is usually created by the Terraform script and conventionally follows the pattern: <code>GcDc-&lt;PROJECT>-msi-argocd</code>.</gcds-text>
<gcds-text character-limit=false>To set up the MSI in the bootstrap cluster, you need to declare either the <code>MSI</code> or the <code>MSI_RESOURCE_ID</code> environment variable in the bootstrap cluster setup script:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Set if the MSI has already been added beforehand</span>
</span></span><span style=display:flex><span>MSI<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set if the MSI hasn&#39;t already been added beforehand</span>
</span></span><span style=display:flex><span>MSI_RESOURCE_ID<span style=color:#f92672>=</span>
</span></span></code></pre></div><blockquote><gcds-text character-limit=false><strong>Note</strong>: The GC Cloud One Azure team is working on a custom role so we won&rsquo;t have to request the MSI be added beforehand due to lack of permissions on the webtop.</gcds-text></blockquote><gcds-heading tag=h2 id=bootstrap-cluster character-limit=false>Bootstrap Cluster</gcds-heading>
<gcds-heading tag=h3 id=setup character-limit=false>Setup</gcds-heading>
<gcds-text character-limit=false>The following set of commands will setup the bootstrap cluster for you.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/gccloudone/bootstrap-cluster
</span></span><span style=display:flex><span>cd bootstrap-cluster
</span></span><span style=display:flex><span>./setup.sh
</span></span></code></pre></div><p>You can refer to the results of this operation in
<gcds-link href=/docs/sops/bootstrap-cluster.txt>this file</gcds-link>.</p><gcds-heading tag=h3 id=retrieve-kubeconfig-context character-limit=false>Retrieve Kubeconfig context</gcds-heading>
<gcds-text character-limit=false>After the initial setup the kubeconfig will be updated to point to the newly created cluster.</gcds-text>
<gcds-text character-limit=false>However if ever you need to re-establish this context simply enter the following command.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>export KUBECONFIG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>k3d kubeconfig get bootstrap-local-cc-00<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><gcds-heading tag=h3 id=custom-ca character-limit=false>Custom CA</gcds-heading>
<gcds-text character-limit=false>In some scenarios, you might require a Custom Certificate Authority (CA).</gcds-text>
<gcds-text character-limit=false>This is often the case when you need to secure internal communication within your organization, or when you&rsquo;re using self-signed certificates that aren&rsquo;t recognized by a public CA.</gcds-text>
<gcds-text character-limit=false>When creating such a secure environment, k3d initiates its setup based on the following reference point:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/usr/local/share/ca-certificates/custom.crt
</span></span></code></pre></div><gcds-text character-limit=false>For applications like Argo CD that also need to recognize your Custom CA, you must also run this command:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f certs.yaml
</span></span></code></pre></div><gcds-text character-limit=false>Of which the file contents of <code>certs.yaml</code> should have a structure as shown:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ConfigMap
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: custom-certs
</span></span><span style=display:flex><span>  namespace: platform-management-system
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  custom.crt: |-
</span></span><span style=display:flex><span>    -----BEGIN CERTIFICATE-----
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    -----END CERTIFICATE-----
</span></span></code></pre></div><gcds-text character-limit=false>Once this is done, you will need to restart all Argo CD pods to load the Custom CA:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl rollout restart deploy -n platform-management-system
</span></span></code></pre></div><blockquote><gcds-text character-limit=false><strong>Recommendation</strong>: This is a suitable opportunity to deploy these changes to your target cluster as well.</gcds-text></blockquote><gcds-heading tag=h3 id=transfer-control character-limit=false>Transfer Control</gcds-heading>
<gcds-text character-limit=false>Before moving forward with this step, it is advisable to first log into Argo CD and initiate a sync operation.</gcds-text>
<gcds-text character-limit=false>As a result, you might observe several resources indicating that the target cluster does not exist.</gcds-text>
<gcds-text character-limit=false>To proceed, execute the following command:</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./register.sh
</span></span></code></pre></div><gcds-text character-limit=false>This command uses the .env variables previously entered to gather the Kubernetes context and create a secret that Argo CD can use.</gcds-text>
<gcds-text character-limit=false>Once this secret is created, Argo CD will immediately begin deploying the full Aurora platform within the target cluster.</gcds-text>
<gcds-heading tag=h4 id=custom-ca-1 character-limit=false>Custom CA</gcds-heading>
<gcds-text character-limit=false>If you omitted the step of deploying the custom-certificates to the target cluster earlier, it is crucial to do so now.</gcds-text>
<gcds-text character-limit=false>This ensures that Argo CD will function successfully within your target cluster.</gcds-text>
<gcds-heading tag=h4 id=workaround character-limit=false>Workaround</gcds-heading>
<gcds-text character-limit=false>Unfortunately, there is an unavoidable manual step in this process. You will need to apply the patch command listed below to a specific resource.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl patch deployment argocd-repo-server <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -n platform-management-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;spec&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;template&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;metadata&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;labels&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;aadpodidbinding&#34;:&#34;argocd-vault-plugin&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }&#39;</span>
</span></span></code></pre></div><gcds-text character-limit=false>Once you&rsquo;ve successfully completed this action, all components should be functional and fully deployed within the target cluster.</gcds-text>
<gcds-heading tag=h3 id=cleanup character-limit=false>Cleanup</gcds-heading>
<gcds-text character-limit=false>The following commands guide you through the process of cleaning up the bootstrap cluster.</gcds-text><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./cleanup.sh
</span></span></code></pre></div><p>You can refer to the results of this operation in
<gcds-link href=/docs/sops/bootstrap-cluster-cleanup.txt>this file</gcds-link>.</p><gcds-date-modified lang=en>2025-01-01</gcds-date-modified></section></gcds-grid></gcds-container></main><gcds-footer lang=en display=compact contextual-heading=Aurora contextual-links='{ "Contact us": "/contact","Report an issue": "https://github.com/gccloudone/aurora/issues/new/choose","About us": "/about" }'></gcds-footer><script src=https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js></script><script>const style=document.createElement("style");style.innerHTML=`
    .glightbox-container.glightbox-custom-white-bg img {
      background: white !important;
    }
  `,document.head.appendChild(style);const lightbox=GLightbox({openEffect:"zoom",closeEffect:"fade",skin:"custom-white-bg"})</script></body></html>